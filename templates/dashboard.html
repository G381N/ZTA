<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è ZTA Behavioral Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#667eea',
                        'secondary': '#764ba2',
                        'accent': '#f093fb',
                        'dark': '#1a202c',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card-shadow:hover {
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -2px rgba(0, 0, 0, 0.08);
        }
        .anomaly-item {
            transition: all 0.2s ease;
        }
        .anomaly-item:hover {
            transform: translateX(4px);
        }
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-2xl">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full">
                        <i class="fas fa-shield-alt text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold tracking-tight">ZTA Monitor</h1>
                        <p class="text-xl opacity-90">Behavioral Security Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-right">
                        <p class="text-sm opacity-80">Last Updated</p>
                        <p class="font-semibold" id="last-updated">Loading...</p>
                    </div>
                    <button onclick="refreshDashboard()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all duration-200 flex items-center space-x-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Trust Score Card -->
            <div class="bg-white rounded-2xl p-6 card-shadow hover:scale-105 transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-gradient-to-r from-green-400 to-green-600 p-3 rounded-full">
                        <i class="fas fa-shield-check text-white text-lg"></i>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Trust Score</p>
                        <p class="text-3xl font-bold text-gray-800" id="trust-score">0</p>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium" id="risk-level">Loading...</span>
                    <div class="h-2 bg-gray-200 rounded-full w-20">
                        <div class="h-2 bg-gradient-to-r from-green-400 to-green-600 rounded-full trust-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Anomalies Card -->
            <div class="bg-white rounded-2xl p-6 card-shadow hover:scale-105 transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-gradient-to-r from-red-400 to-red-600 p-3 rounded-full">
                        <i class="fas fa-exclamation-triangle text-white text-lg"></i>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Anomalies (24h)</p>
                        <p class="text-3xl font-bold text-gray-800" id="anomaly-count">0</p>
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="model-status">Loading...</span>
                </div>
            </div>

            <!-- Active Events Card -->
            <div class="bg-white rounded-2xl p-6 card-shadow hover:scale-105 transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 p-3 rounded-full">
                        <i class="fas fa-activity text-white text-lg"></i>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Active Events</p>
                        <p class="text-3xl font-bold text-gray-800" id="total-events">0</p>
                    </div>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span><i class="fas fa-desktop mr-1"></i><span id="unique-apps">0</span> Apps</span>
                    <span><i class="fas fa-network-wired mr-1"></i><span id="network-connections">0</span> Net</span>
                </div>
            </div>

            <!-- System Status Card -->
            <div class="bg-white rounded-2xl p-6 card-shadow hover:scale-105 transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-gradient-to-r from-purple-400 to-purple-600 p-3 rounded-full">
                        <i class="fas fa-server text-white text-lg"></i>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">System Status</p>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-lg font-semibold text-green-600">Active</span>
                        </div>
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    <span><i class="fas fa-exclamation-circle mr-1"></i><span id="suspicious-events">0</span> Alerts</span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Anomalies Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl card-shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-gradient-to-r from-red-400 to-red-600 p-2 rounded-lg">
                                    <i class="fas fa-exclamation-triangle text-white"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-gray-800">Security Anomalies</h2>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span class="text-sm text-gray-500">Live Monitoring</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="recent-anomalies" class="max-h-96 overflow-y-auto space-y-4">
                            <div class="flex items-center justify-center py-12">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                                    <p class="text-gray-500">Loading anomaly data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Activity Panel -->
            <div class="space-y-6">
                <!-- App Launches -->
                <div class="bg-white rounded-2xl card-shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div class="bg-gradient-to-r from-blue-400 to-blue-600 p-2 rounded-lg">
                                <i class="fas fa-rocket text-white"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800">App Launches</h3>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="app-launches" class="space-y-3 max-h-48 overflow-y-auto">
                            <p class="text-sm text-gray-500 text-center py-6">Loading app activity...</p>
                        </div>
                    </div>
                </div>

                <!-- Network Activity -->
                <div class="bg-white rounded-2xl card-shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div class="bg-gradient-to-r from-purple-400 to-purple-600 p-2 rounded-lg">
                                <i class="fas fa-network-wired text-white"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800">Network Activity</h3>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="network-activity" class="space-y-3 max-h-48 overflow-y-auto">
                            <p class="text-sm text-gray-500 text-center py-6">Loading network activity...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Status Section -->
        <div class="mt-8">
            <div id="training-status" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-gradient-to-r from-blue-500 to-indigo-500 p-2 rounded-lg">
                            <i class="fas fa-brain text-white"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">System Learning Status</h3>
                    </div>
                    <div id="training-phase-badge" class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                        Loading...
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="training-progress">0%</div>
                        <div class="text-sm text-gray-600">Learning Progress</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="training-events">0</div>
                        <div class="text-sm text-gray-600">Training Events</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold" id="detection-status">Not Active</div>
                        <div class="text-sm text-gray-600">Anomaly Detection</div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-indigo-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 text-sm text-gray-600 text-center" id="training-description">
                        Initializing system training...
                    </div>
                </div>
            </div>
        </div>

        <!-- Learned Patterns Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
            <!-- Usual Login Hours -->
            <div class="bg-white rounded-2xl card-shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-clock text-blue-500 mr-3"></i>
                        Usual Login Hours
                    </h3>
                </div>
                <div class="p-6">
                    <div id="usual-hours" class="space-y-3">
                        <p class="text-sm text-gray-500 text-center py-6">Learning your patterns...</p>
                    </div>
                </div>
            </div>

            <!-- Most Used Apps -->
            <div class="bg-white rounded-2xl card-shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-apps text-green-500 mr-3"></i>
                        Most Used Apps
                    </h3>
                </div>
                <div class="p-6">
                    <div id="usual-apps" class="space-y-3">
                        <p class="text-sm text-gray-500 text-center py-6">Learning your app usage...</p>
                    </div>
                </div>
            </div>

            <!-- Activity Patterns -->
            <div class="bg-white rounded-2xl card-shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-chart-bar text-purple-500 mr-3"></i>
                        Activity Patterns
                    </h3>
                </div>
                <div class="p-6">
                    <div id="activity-patterns" class="space-y-3">
                        <p class="text-sm text-gray-500 text-center py-6">Learning your schedule...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <!-- Trust Score Chart -->
            <div class="bg-white rounded-2xl card-shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-chart-line text-primary mr-3"></i>
                        Trust Score History
                    </h3>
                </div>
                <div class="p-6">
                    <div id="trust-chart" style="height: 300px;"></div>
                </div>
            </div>

            <!-- Anomalies Timeline -->
            <div class="bg-white rounded-2xl card-shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-chart-bar text-danger mr-3"></i>
                        Anomalies Timeline
                    </h3>
                </div>
                <div class="p-6">
                    <div id="anomalies-chart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let refreshInterval;
        let isLoading = false;
        let lastRefresh = 0;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            startAutoRefresh();
        });
        
        function startAutoRefresh() {
            // Refresh every 5 seconds for more live updates
            refreshInterval = setInterval(refreshDashboard, 5000);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }
        
        async function refreshDashboard() {
            if (isLoading) return;
            
            const now = Date.now();
            if (now - lastRefresh < 2000) return; // Prevent too frequent calls
            lastRefresh = now;
            
            isLoading = true;
            
            try {
                // Fetch all data in parallel with cache busting
                const timestamp = new Date().getTime();
                const apiBase = 'http://localhost:8080';
                const [trustResponse, anomaliesResponse, historyResponse, statusResponse, activityResponse, patternsResponse] = await Promise.all([
                    fetch(`${apiBase}/api/trust?_t=${timestamp}`),
                    fetch(`${apiBase}/api/anomalies?_t=${timestamp}`),
                    fetch(`${apiBase}/api/trust/history?_t=${timestamp}`),
                    fetch(`${apiBase}/api/status?_t=${timestamp}`),
                    fetch(`${apiBase}/api/activity?_t=${timestamp}`),
                    fetch(`${apiBase}/api/learned-patterns?_t=${timestamp}`)
                ]);
                
                // Check if responses are ok
                const trustData = trustResponse.ok ? await trustResponse.json() : null;
                const anomaliesData = anomaliesResponse.ok ? await anomaliesResponse.json() : null;
                const historyData = historyResponse.ok ? await historyResponse.json() : null;
                const statusData = statusResponse.ok ? await statusResponse.json() : null;
                const activityData = activityResponse.ok ? await activityResponse.json() : null;
                const patternsData = patternsResponse.ok ? await patternsResponse.json() : null;
                
                // Update trust score
                if (trustData && trustData.data) {
                    updateTrustScore(trustData.data);
                }
                
                // Update recent anomalies
                if (anomaliesData && anomaliesData.data) {
                    updateRecentAnomalies(anomaliesData.data.anomalies || []);
                }
                
                // Update charts
                if (historyData && historyData.data) {
                    updateTrustChart(historyData.data.history || []);
                }
                if (anomaliesData && anomaliesData.data) {
                    updateAnomaliesChart(anomaliesData.data.anomalies || []);
                }
                
                // Update system status
                if (statusData && statusData.data) {
                    updateSystemStatus(statusData.data);
                }
                
                // Update live activity
                if (activityData && activityData.data) {
                    const anomalies = anomaliesData && anomaliesData.data ? anomaliesData.data.anomalies || [] : [];
                    updateLiveActivity(activityData.data, anomalies);
                }
                
                // Update learned patterns
                if (patternsData && patternsData.data) {
                    updateLearnedPatterns(patternsData.data);
                }
                
                // Update last updated time
                document.getElementById('last-updated').textContent = new Date().toLocaleString();
                
                console.log(`Dashboard refreshed at ${new Date().toLocaleTimeString()}`);
                
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                showError('Failed to refresh dashboard data: ' + error.message);
            } finally {
                isLoading = false;
            }
        }
        
        function updateTrustScore(trustData) {
            const scoreElement = document.getElementById('trust-score');
            const riskElement = document.getElementById('risk-level');
            const anomalyCountElement = document.getElementById('anomaly-count');
            const progressBar = document.querySelector('.trust-progress');
            
            // Update trust score with animation
            const newScore = parseFloat(trustData.current_score || 0).toFixed(1);
            scoreElement.textContent = newScore;
            riskElement.textContent = trustData.risk_level || 'Unknown';
            
            // Update progress bar
            const score = parseFloat(newScore);
            progressBar.style.width = `${score}%`;
            
            // Update color based on score
            scoreElement.className = 'text-3xl font-bold';
            riskElement.className = 'text-sm font-medium';
            
            if (score >= 80) {
                scoreElement.classList.add('text-green-600');
                riskElement.classList.add('text-green-600');
                riskElement.textContent = 'HIGH TRUST - Minimal friction';
                progressBar.className = 'h-2 bg-gradient-to-r from-green-400 to-green-600 rounded-full trust-progress';
            } else if (score >= 40) {
                scoreElement.classList.add('text-yellow-600');
                riskElement.classList.add('text-yellow-600');
                riskElement.textContent = 'MEDIUM TRUST - Adaptive friction enabled';
                progressBar.className = 'h-2 bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-full trust-progress';
            } else {
                scoreElement.classList.add('text-red-600');
                riskElement.classList.add('text-red-600');
                riskElement.textContent = 'LOW TRUST - Potential intrusion detected!';
                progressBar.className = 'h-2 bg-gradient-to-r from-red-400 to-red-600 rounded-full trust-progress';
            }
            
            // Update anomaly count
            if (trustData.last_24h && trustData.last_24h.anomaly_count !== undefined) {
                anomalyCountElement.textContent = trustData.last_24h.anomaly_count;
            }
        }
        
        function updateRecentAnomalies(anomalies) {
            const container = document.getElementById('recent-anomalies');
            if (!anomalies || anomalies.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">All Clear!</h3>
                        <p class="text-gray-500">No recent anomalies detected. System is operating normally.</p>
                    </div>
                `;
                return;
            }
            
            // Group anomalies by type and app
            const groups = {};
            anomalies.forEach(anomaly => {
                const type = anomaly.anomaly_type || 'general_anomaly';
                const app = anomaly.app_name || 'Unknown';
                const key = `${type}::${app}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(anomaly);
            });
            
            // Build grouped anomaly list
            let html = '';
            Object.entries(groups).forEach(([key, group]) => {
                const [type, app] = key.split('::');
                const count = group.length;
                const maxSeverity = Math.max(...group.map(a => a.severity || 0));
                const severityColor = maxSeverity > 0.7 ? 'text-red-600' : maxSeverity > 0.4 ? 'text-yellow-600' : 'text-blue-600';
                
                html += `
                    <div class="border border-gray-200 rounded-xl overflow-hidden">
                        <div class="bg-gray-50 p-4 cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleGroup(this)">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-3 h-3 ${severityColor === 'text-red-600' ? 'bg-red-400' : severityColor === 'text-yellow-600' ? 'bg-yellow-400' : 'bg-blue-400'} rounded-full"></div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${formatAnomalyType(type)}</h4>
                                        <p class="text-sm text-gray-500">App: ${app}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">${count} events</span>
                                    <span class="px-2 py-1 ${severityColor === 'text-red-600' ? 'bg-red-100 text-red-800' : severityColor === 'text-yellow-600' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'} text-xs font-semibold rounded-full">${Math.round(maxSeverity*100)}% severity</span>
                                    <i class="fas fa-chevron-down text-gray-400 transform transition-transform group-expand"></i>
                                </div>
                            </div>
                        </div>
                        <div class="hidden p-4 bg-white space-y-3 group-content">
                `;
                
                group.forEach(anomaly => {
                    const isApproved = anomaly.approved || false;
                    html += `
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg ${isApproved ? 'opacity-50' : ''}" data-anomaly-id="${anomaly.id || 0}">
                            <div class="w-2 h-2 ${isApproved ? 'bg-green-400' : 'bg-gray-400'} rounded-full mt-2"></div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-700 mb-1">
                                    ${anomaly.description || 'No description available'}
                                    ${isApproved ? '<span class="text-green-600 font-medium ml-2">(APPROVED)</span>' : ''}
                                </p>
                                <div class="flex items-center space-x-4 text-xs text-gray-500 mb-2">
                                    <span><i class="fas fa-clock mr-1"></i>${new Date(anomaly.timestamp).toLocaleString()}</span>
                                    <span><i class="fas fa-fire mr-1"></i>${Math.round((anomaly.severity || 0)*100)}% severity</span>
                                    ${anomaly.event_type ? `<span><i class="fas fa-tag mr-1"></i>${anomaly.event_type}</span>` : ''}
                                </div>
                                ${!isApproved && anomaly.id ? `
                                <div class="flex space-x-2">
                                    <button onclick="approveAnomaly(${anomaly.id})" 
                                            class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 text-xs rounded-md transition-colors">
                                        <i class="fas fa-check mr-1"></i>Approve as Normal
                                    </button>
                                    <button onclick="showAnomalyDetails(${anomaly.id})" 
                                            class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 text-xs rounded-md transition-colors">
                                        <i class="fas fa-info mr-1"></i>Details
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }
        
        function toggleGroup(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.group-expand');
            
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }
        
        function updateSystemStatus(statusData) {
            const modelElement = document.getElementById('model-status');
            
            if (statusData.model_status && statusData.model_status.is_trained) {
                modelElement.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i>Model Trained & Active';
            } else {
                modelElement.innerHTML = '<i class="fas fa-exclamation-circle text-yellow-500 mr-1"></i>Model Training...';
            }
        }
        
        function updateLiveActivity(activityData, anomalies = []) {
            // Update app launches - look for actual app launches from recent events
            const appContainer = document.getElementById('app-launches');
            
            // Filter for app launch events from recent events
            const appLaunches = activityData.recent_events ? 
                activityData.recent_events.filter(event => 
                    event.event_type && (
                        event.event_type.includes('app_launch') || 
                        event.event_type.includes('application_launch') ||
                        event.event_type.includes('app_opened')
                    )
                ).slice(0, 10) : [];
            
            // Also add app-related anomalies to app launches
            const appAnomalies = anomalies.filter(anomaly => 
                anomaly.anomaly_type && (
                    anomaly.anomaly_type.includes('app') || 
                    anomaly.anomaly_type.includes('application') ||
                    anomaly.event_type && anomaly.event_type.includes('app')
                )
            );
            
            // Combine app launches and app anomalies
            const allAppActivity = [...appLaunches, ...appAnomalies.map(a => ({
                timestamp: a.timestamp,
                app_name: a.app_name || 'Unknown App',
                event_type: a.anomaly_type || a.event_type,
                trust_impact: -(a.severity || 0.5) * 100,  // Convert severity to negative impact
                is_anomaly: true
            }))].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 10);
            
            if (allAppActivity.length > 0) {
                appContainer.innerHTML = allAppActivity.map(launch => `
                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="w-2 h-2 ${launch.is_anomaly ? 'bg-red-400' : (launch.app_name && ['nmap', 'metasploit', 'hydra', 'aircrack', 'wireshark'].includes(launch.app_name) ? 'bg-red-400' : 'bg-blue-400')} rounded-full"></div>
                        <div class="flex-1">
                            <p class="font-medium text-sm text-gray-800">${launch.app_name || 'Unknown App'}</p>
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <span>${new Date(launch.timestamp).toLocaleTimeString()}</span>
                                ${launch.is_anomaly ? '<span class="text-red-600 font-medium">ANOMALY</span>' : ''}
                            </div>
                        </div>
                        <span class="text-xs ${(launch.trust_impact || 0) < 0 ? 'text-red-600' : 'text-green-600'}">${(launch.trust_impact || 0) > 0 ? '+' : ''}${(launch.trust_impact || 0).toFixed(1)}</span>
                    </div>
                `).join('');
            } else {
                appContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-6">No recent app launches</p>';
            }
            
            // Update network activity
            const networkContainer = document.getElementById('network-activity');
            const networkEvents = activityData.recent_events ? 
                activityData.recent_events.filter(event => 
                    event.event_type && (
                        event.event_type.includes('network') || 
                        event.event_type.includes('connection') ||
                        event.event_type.includes('flooding')
                    )
                ).slice(0, 10) : [];
                
            if (networkEvents.length > 0) {
                networkContainer.innerHTML = networkEvents.map(network => `
                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="w-2 h-2 ${network.event_type.includes('flooding') ? 'bg-red-400' : 'bg-purple-400'} rounded-full"></div>
                        <div class="flex-1">
                            <p class="font-medium text-sm text-gray-800">${(network.event_type || 'network').replace(/_/g, ' ').toUpperCase()}</p>
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <span>${new Date(network.timestamp).toLocaleTimeString()}</span>
                                ${network.app_name ? `<span>${network.app_name}</span>` : ''}
                                <span class="${(network.trust_impact || 0) > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${(network.trust_impact || 0) > 0 ? '+' : ''}${(network.trust_impact || 0)}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                networkContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-6">No recent network activity</p>';
            }
            
            // Update activity stats
            const stats = activityData.activity_stats;
            if (stats) {
                document.getElementById('total-events').textContent = stats.total_events || 0;
                document.getElementById('unique-apps').textContent = stats.unique_apps || 0;
                document.getElementById('network-connections').textContent = stats.network_connections || 0;
                document.getElementById('suspicious-events').textContent = stats.suspicious_events || 0;
            }
        }
        
        function updateTrustChart(history) {
            if (!history || history.length === 0) {
                document.getElementById('trust-chart').innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">üìà Collecting trust score data...</p></div>';
                return;
            }
            
            const timestamps = history.map(h => new Date(h.timestamp));
            const scores = history.map(h => parseFloat(h.score || 0));
            
            const trace = {
                x: timestamps,
                y: scores,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Trust Score',
                line: {
                    color: '#667eea',
                    width: 3
                },
                marker: {
                    color: '#764ba2',
                    size: 6
                },
                hovertemplate: '<b>Trust Score</b><br>Time: %{x}<br>Score: %{y:.1f}<extra></extra>'
            };
            
            const layout = {
                title: '',
                xaxis: {
                    title: 'Time',
                    type: 'date',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                yaxis: {
                    title: 'Trust Score',
                    range: [0, 100],
                    tickformat: '.1f',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                margin: { t: 20, r: 20, b: 40, l: 40 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'ui-sans-serif, system-ui, sans-serif' }
            };
            
            Plotly.newPlot('trust-chart', [trace], layout, {responsive: true});
        }
        
        function updateAnomaliesChart(anomalies) {
            if (!anomalies || anomalies.length === 0) {
                document.getElementById('anomalies-chart').innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-gray-500">üìä No anomalies to display - system is stable!</p></div>';
                return;
            }
            
            // Group anomalies by hour for better visualization
            const anomaliesByHour = {};
            anomalies.forEach(anomaly => {
                const hour = new Date(anomaly.timestamp).toISOString().slice(0, 13) + ':00:00.000Z';
                if (!anomaliesByHour[hour]) {
                    anomaliesByHour[hour] = [];
                }
                anomaliesByHour[hour].push(anomaly);
            });
            
            const timestamps = Object.keys(anomaliesByHour).map(h => new Date(h));
            const counts = Object.values(anomaliesByHour).map(arr => arr.length);
            
            const trace = {
                x: timestamps,
                y: counts,
                type: 'bar',
                name: 'Anomalies per Hour',
                marker: {
                    color: counts.map(count => count > 10 ? '#ef4444' : count > 5 ? '#f59e0b' : '#10b981'),
                    opacity: 0.8
                },
                hovertemplate: '<b>Anomalies</b><br>Hour: %{x}<br>Count: %{y}<extra></extra>'
            };
            
            const layout = {
                title: '',
                xaxis: {
                    title: 'Time',
                    type: 'date',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                yaxis: {
                    title: 'Anomaly Count',
                    tickformat: '.0f',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                margin: { t: 20, r: 20, b: 40, l: 40 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'ui-sans-serif, system-ui, sans-serif' }
            };
            
            Plotly.newPlot('anomalies-chart', [trace], layout, {responsive: true});
        }
        
        function formatAnomalyType(type) {
            const typeMap = {
                'unusual_time': 'üïê Unusual Time Activity',
                'unknown_application': '‚ùì Unknown Application',
                'rapid_switching': '‚ö° Rapid App Switching',
                'weekend_work': 'üìÖ Weekend Activity',
                'suspicious_pattern': 'üö® Suspicious Pattern',
                'connection_flooding': 'üåä Network Flooding',
                'network_connection': 'üîó Network Activity',
                'network_anomaly': 'üåê Network Anomaly',
                'security_tool': 'üîí Security Tool Detected',
                'app_launch': 'üöÄ App Launch',
                'general_anomaly': '‚ö†Ô∏è General Anomaly'
            };
            
            return typeMap[type] || `‚ö†Ô∏è ${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
        }
        
        function updateLearnedPatterns(patterns) {
            // Update usual hours
            const hoursContainer = document.getElementById('usual-hours');
            if (patterns.usual_login_hours && patterns.usual_login_hours.length > 0) {
                hoursContainer.innerHTML = patterns.usual_login_hours.slice(0, 8).map(hour => `
                    <div class="flex items-center justify-between p-2 bg-blue-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-clock text-blue-500"></i>
                            <span class="font-medium">${hour.hour}</span>
                        </div>
                        <span class="text-sm text-blue-600">${hour.frequency} times</span>
                    </div>
                `).join('');
            } else {
                hoursContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-6">No login patterns learned yet</p>';
            }
            
            // Update usual apps
            const appsContainer = document.getElementById('usual-apps');
            if (patterns.usual_apps && patterns.usual_apps.length > 0) {
                appsContainer.innerHTML = patterns.usual_apps.slice(0, 10).map(app => `
                    <div class="flex items-center justify-between p-2 bg-green-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-desktop text-green-500"></i>
                            <span class="font-medium text-sm">${app.app}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-green-600">${app.usage_count}</span>
                            <button onclick="removeLearnedApp('${app.app}')" 
                                class="text-red-500 hover:text-red-700 text-xs p-1" 
                                title="Remove from learned apps">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                appsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-6">No app patterns learned yet</p>';
            }
            
            // Update activity patterns
            const patternsContainer = document.getElementById('activity-patterns');
            if (patterns.activity_patterns && Object.keys(patterns.activity_patterns).length > 0) {
                let html = '';
                Object.entries(patterns.activity_patterns).slice(0, 3).forEach(([day, activities]) => {
                    const topActivity = activities[0];
                    html += `
                        <div class="flex items-center justify-between p-2 bg-purple-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-calendar text-purple-500"></i>
                                <div>
                                    <span class="font-medium text-sm">${day}</span>
                                    <div class="text-xs text-gray-500">${topActivity.hour}</div>
                                </div>
                            </div>
                            <span class="text-sm text-purple-600">${topActivity.activity}</span>
                        </div>
                    `;
                });
                patternsContainer.innerHTML = html;
            } else {
                patternsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-6">Learning your schedule...</p>';
            }
        }
        
        function showError(message) {
            console.error(message);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
            errorDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }
        
        // Training status and anomaly approval functions
        async function updateTrainingStatus() {
            try {
                const response = await fetch('/api/training-status');
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data;
                    
                    // Update phase badge
                    const phaseBadge = document.getElementById('training-phase-badge');
                    const phaseLabels = {
                        'initial_training': 'Initial Training',
                        'baseline_validation': 'Baseline Validation',
                        'active_monitoring': 'Active Monitoring'
                    };
                    phaseBadge.textContent = phaseLabels[status.current_phase] || status.current_phase;
                    phaseBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${
                        status.current_phase === 'active_monitoring' ? 'bg-green-100 text-green-800' :
                        status.current_phase === 'baseline_validation' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-blue-100 text-blue-800'
                    }`;
                    
                    // Update training progress
                    const progress = Math.round(status.phase_info.progress || 0);
                    document.getElementById('training-progress').textContent = `${progress}%`;
                    document.getElementById('progress-bar').style.width = `${progress}%`;
                    
                    // Update training events
                    document.getElementById('training-events').textContent = status.total_training_events || 0;
                    
                    // Update detection status
                    const detectionElement = document.getElementById('detection-status');
                    detectionElement.textContent = status.anomaly_detection_active ? 'Active' : 'Not Active';
                    detectionElement.className = `text-2xl font-bold ${
                        status.anomaly_detection_active ? 'text-green-600' : 'text-gray-600'
                    }`;
                    
                    // Update description
                    document.getElementById('training-description').textContent = 
                        status.phase_info.description || 'System is learning...';
                }
            } catch (error) {
                console.error('Error updating training status:', error);
            }
        }
        
        async function approveAnomaly(anomalyId) {
            try {
                const response = await fetch(`/api/anomalies/${anomalyId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    showSuccessMessage(`Anomaly approved as normal behavior`);
                    
                    // Update the UI immediately
                    const anomalyElement = document.querySelector(`[data-anomaly-id="${anomalyId}"]`);
                    if (anomalyElement) {
                        anomalyElement.classList.add('opacity-50');
                        const statusSpan = anomalyElement.querySelector('.text-gray-700');
                        if (statusSpan) {
                            statusSpan.innerHTML += ' <span class="text-green-600 font-medium ml-2">(APPROVED)</span>';
                        }
                        
                        // Hide approve buttons
                        const buttonsDiv = anomalyElement.querySelector('.flex.space-x-2');
                        if (buttonsDiv) {
                            buttonsDiv.style.display = 'none';
                        }
                    }
                    
                    // Refresh data
                    refreshDashboard();
                } else {
                    showError(data.message || 'Failed to approve anomaly');
                }
            } catch (error) {
                console.error('Error approving anomaly:', error);
                showError('Failed to approve anomaly');
            }
        }
        
        async function removeLearnedApp(appName) {
            try {
                const response = await fetch(`/api/learned-apps/${encodeURIComponent(appName)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage(`Removed "${appName}" from learned applications`);
                    // Refresh the training status to update the learned apps list
                    updateTrainingStatus();
                } else {
                    showError(data.message || 'Failed to remove learned app');
                }
            } catch (error) {
                console.error('Error removing learned app:', error);
                showError('Failed to remove learned app');
            }
        }
        
        function showAnomalyDetails(anomalyId) {
            // Simple alert for now - could be enhanced with a modal
            alert(`Anomaly ID: ${anomalyId}\n\nClick "Approve as Normal" if this is expected behavior that should be learned by the system.`);
        }
        
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
            successDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }
        
        // Enhanced refresh function to include training status
        const originalRefreshDashboard = refreshDashboard;
        refreshDashboard = function() {
            originalRefreshDashboard();
            updateTrainingStatus();
        };
        
        // Handle page visibility changes for better performance
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                refreshDashboard();
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
