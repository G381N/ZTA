<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è ZTA Behavioral Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#667eea',
                        'secondary': '#764ba2',
                        'accent': '#f093fb',
                        'dark': '#1a202c',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                        'danger': '#ef4444'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card-shadow:hover {
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -2px rgba(0, 0, 0, 0.08);
        }
        .anomaly-item {
            transition: all 0.2s ease;
        }
        .anomaly-item:hover {
            transform: translateX(4px);
        }
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @media (prefers-color-scheme: dark) {
            .dark-mode {
                background-color: #1a202c;
                color: #e2e8f0;
            }
        }
    </style>
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        
        .trust-score {
            text-align: center;
        }
        
        .trust-value {
            font-size: 3rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        
        .trust-high { color: #28a745; }
        .trust-medium { color: #ffc107; }
        .trust-low { color: #fd7e14; }
        .trust-critical { color: #dc3545; }
        
        .risk-level {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-block;
            margin-top: 0.5rem;
        }
        
        .risk-minimal { background-color: #d4edda; color: #155724; }
        .risk-low { background-color: #fff3cd; color: #856404; }
        .risk-medium { background-color: #ffeaa7; color: #d68910; }
        .risk-high { background-color: #f8d7da; color: #721c24; }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-weight: 500;
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .anomaly-item {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }
        
        .anomaly-type {
            font-weight: 600;
            color: #856404;
            margin-bottom: 0.25rem;
        }
        
        .anomaly-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .anomaly-time {
            font-size: 0.8rem;
            color: #999;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }
        
        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .chart-container {
            grid-column: 1 / -1;
            margin-top: 1rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-running { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .trust-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ°Ô∏è Behavioral Monitoring Dashboard</h1>
        <p class="subtitle">AI-Based Dynamic Trust Scoring System</p>
    </div>
    
    <div class="container">
        <div class="dashboard-grid">
            <!-- Trust Score Card -->
            <div class="card trust-score">
                <div class="card-header">
                    <h2 class="card-title">Trust Score</h2>
                    <span class="status-indicator status-running"></span>
                </div>
                <div class="trust-value" id="trust-score">{{ trust_score }}</div>
                <div class="risk-level" id="risk-level">{{ risk_level }}</div>
                <button class="refresh-btn" onclick="refreshDashboard()">
                    üîÑ Refresh Data
                </button>
            </div>
            
            <!-- System Statistics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">System Status</h2>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Anomalies (24h)</span>
                    <span class="stat-value" id="anomaly-count">{{ anomaly_count }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Updated</span>
                    <span class="stat-value" id="last-updated">{{ last_updated[:16] }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Monitoring Status</span>
                    <span class="stat-value">
                        <span class="status-indicator status-running"></span>
                        Active
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Model Status</span>
                    <span class="stat-value" id="model-status">Loading...</span>
                </div>
            </div>
            
            <!-- Recent Anomalies -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Anomalies</h2>
                </div>
                <div id="recent-anomalies">
                    <p style="text-align: center; color: #666; padding: 2rem;">
                        Loading anomalies...
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Live Activity Section -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üöÄ Live System Activity (Last 30 min)</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>üì± Recent App Launches</h5>
                        <div id="app-launches" class="activity-list" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #666; padding: 1rem;">Loading app activity...</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>üåê Network Activity</h5>
                        <div id="network-activity" class="activity-list" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #666; padding: 1rem;">Loading network activity...</p>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="activity-stats" id="activity-stats" style="display: flex; justify-content: space-around; flex-wrap: wrap;">
                            <span class="stat-item badge badge-info">üìä <span id="total-events">0</span> events</span>
                            <span class="stat-item badge badge-success">üì± <span id="unique-apps">0</span> apps</span>
                            <span class="stat-item badge badge-primary">üåê <span id="network-connections">0</span> connections</span>
                            <span class="stat-item badge badge-warning">‚ö†Ô∏è <span id="suspicious-events">0</span> alerts</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Trust Score Chart -->
        <div class="card chart-container">
            <div class="card-header">
                <h2 class="card-title">Trust Score History (24h)</h2>
            </div>
            <div id="trust-chart" style="width: 100%; height: 400px;"></div>
        </div>
        
        <!-- Anomalies Timeline Chart -->
        <div class="card chart-container">
            <div class="card-header">
                <h2 class="card-title">Anomalies Timeline (24h)</h2>
            </div>
            <div id="anomalies-chart" style="width: 100%; height: 300px;"></div>
        </div>
    </div>

    <script>
        // Global variables
        let refreshInterval;
        let isLoading = false;
        let lastRefresh = 0;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            startAutoRefresh();
        });
        
        function startAutoRefresh() {
            // Refresh every 5 seconds for more live updates
            refreshInterval = setInterval(refreshDashboard, 5000);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }
        
        async function refreshDashboard() {
            if (isLoading) return;
            
            const now = Date.now();
            if (now - lastRefresh < 2000) return; // Prevent too frequent calls
            lastRefresh = now;
            
            isLoading = true;
            document.body.classList.add('loading');
            
            try {
                // Fetch all data in parallel with cache busting
                const timestamp = new Date().getTime();
                const [trustResponse, anomaliesResponse, historyResponse, statusResponse, activityResponse] = await Promise.all([
                    fetch(`/api/trust?_t=${timestamp}`),
                    fetch(`/api/anomalies?_t=${timestamp}`),
                    fetch(`/api/trust/history?_t=${timestamp}`),
                    fetch(`/api/status?_t=${timestamp}`),
                    fetch(`/api/activity?_t=${timestamp}`)
                ]);
                
                // Check if responses are ok
                const trustData = trustResponse.ok ? await trustResponse.json() : null;
                const anomaliesData = anomaliesResponse.ok ? await anomaliesResponse.json() : null;
                const historyData = historyResponse.ok ? await historyResponse.json() : null;
                const statusData = statusResponse.ok ? await statusResponse.json() : null;
                const activityData = activityResponse.ok ? await activityResponse.json() : null;
                
                // Update trust score
                if (trustData && trustData.data) {
                    updateTrustScore(trustData.data);
                }
                
                // Update recent anomalies
                if (anomaliesData && anomaliesData.data) {
                    updateRecentAnomalies(anomaliesData.data.anomalies || []);
                }
                
                // Update charts
                if (historyData && historyData.data) {
                    updateTrustChart(historyData.data.history || []);
                }
                if (anomaliesData && anomaliesData.data) {
                    updateAnomaliesChart(anomaliesData.data.anomalies || []);
                }
                
                // Update system status
                if (statusData && statusData.data) {
                    updateSystemStatus(statusData.data);
                }
                
                // Update live activity
                if (activityData && activityData.data) {
                    updateLiveActivity(activityData.data);
                }
                
                // Update last updated time
                document.getElementById('last-updated').textContent = new Date().toLocaleString().slice(0, 16);
                
                console.log(`Dashboard refreshed at ${new Date().toLocaleTimeString()}`);
                
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                showError('Failed to refresh dashboard data: ' + error.message);
            } finally {
                isLoading = false;
                document.body.classList.remove('loading');
            }
        }
        
        function updateTrustScore(trustData) {
            const scoreElement = document.getElementById('trust-score');
            const riskElement = document.getElementById('risk-level');
            const anomalyCountElement = document.getElementById('anomaly-count');
            
            // Update trust score with animation
            const newScore = parseFloat(trustData.current_score || 0).toFixed(1);
            scoreElement.textContent = newScore;
            riskElement.textContent = trustData.risk_level || 'Unknown';
            
            // Update color based on score
            scoreElement.className = 'trust-value';
            riskElement.className = 'risk-level';
            
            const score = parseFloat(newScore);
            if (score >= 80) {
                scoreElement.classList.add('trust-high');
                riskElement.classList.add('risk-minimal');
            } else if (score >= 60) {
                scoreElement.classList.add('trust-medium');
                riskElement.classList.add('risk-low');
            } else if (score >= 40) {
                scoreElement.classList.add('trust-low');
                riskElement.classList.add('risk-medium');
            } else {
                scoreElement.classList.add('trust-critical');
                riskElement.classList.add('risk-high');
            }
            
            // Update anomaly count
            if (trustData.last_24h && trustData.last_24h.anomaly_count !== undefined) {
                anomalyCountElement.textContent = trustData.last_24h.anomaly_count;
            }
        }
        
        function updateRecentAnomalies(anomalies) {
            const container = document.getElementById('recent-anomalies');
            if (!anomalies || anomalies.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">üéâ No recent anomalies detected!<br><small>System is operating normally</small></p>';
                return;
            }
            // Group anomalies by type and app
            const groups = {};
            anomalies.forEach(anomaly => {
                const type = anomaly.anomaly_type || 'general_anomaly';
                const app = anomaly.app_name || 'Unknown';
                const key = `${type}::${app}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(anomaly);
            });
            // Build grouped anomaly list
            let html = '<div class="anomaly-group-list" style="max-height: 400px; overflow-y: auto;">';
            Object.entries(groups).forEach(([key, group]) => {
                const [type, app] = key.split('::');
                const count = group.length;
                const maxSeverity = Math.max(...group.map(a => a.severity || 0));
                html += `<div class="anomaly-group">
                    <div class="anomaly-group-header" style="cursor:pointer; background:#f0f0f0; padding:8px; border-radius:6px; margin-bottom:4px;" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span style="font-weight:600;">${formatAnomalyType(type)}</span>
                        <span style="color:#764ba2; margin-left:8px;">App: <b>${app}</b></span>
                        <span style="color:#dc3545; margin-left:8px;">Count: <b>${count}</b></span>
                        <span style="color:#ffc107; margin-left:8px;">Max Severity: <b>${Math.round(maxSeverity*100)}%</b></span>
                        <span style="float:right; color:#667eea;">[Expand]</span>
                    </div>
                    <div class="anomaly-group-items hidden" style="margin-left:12px; margin-bottom:12px;">`;
                group.forEach(anomaly => {
                    html += `<div class="anomaly-item" style="padding:6px 0; border-bottom:1px solid #eee;">
                        <div style="font-size:0.95em; color:#333;">${anomaly.description || 'No description'}</div>
                        <div style="font-size:0.85em; color:#666;">
                            üî• Severity: ${Math.round((anomaly.severity || 0)*100)}% | ‚è∞ ${new Date(anomaly.timestamp).toLocaleString()} ${anomaly.event_type ? `| üì± ${anomaly.event_type}` : ''}
                        </div>
                    </div>`;
                });
                html += '</div></div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function updateSystemStatus(statusData) {
            const modelElement = document.getElementById('model-status');
            
            if (statusData.model_status && statusData.model_status.is_trained) {
                modelElement.innerHTML = '<span class="status-indicator status-running"></span>Trained & Active';
            } else {
                modelElement.innerHTML = '<span class="status-indicator status-warning"></span>Training...';
            }
        }
        
        function updateLiveActivity(activityData) {
            // Update app launches
            const appContainer = document.getElementById('app-launches');
            if (activityData.app_launches && activityData.app_launches.length > 0) {
                appContainer.innerHTML = activityData.app_launches.map(launch => `
                    <div class="activity-item" style="padding: 8px; margin: 4px 0; border-left: 3px solid #007bff; background: #f8f9fa;">
                        <div style="font-weight: 500; color: #007bff;">üì± ${launch.app_name}</div>
                        <div style="font-size: 0.9em; color: #666;">
                            ${new Date(launch.timestamp).toLocaleTimeString()} | 
                            Impact: ${launch.trust_impact > 0 ? '+' : ''}${launch.trust_impact.toFixed(1)}
                        </div>
                    </div>
                `).join('');
            } else {
                appContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem;">No recent app launches detected</p>';
            }
            
            // Update network activity
            const networkContainer = document.getElementById('network-activity');
            if (activityData.network_activity && activityData.network_activity.length > 0) {
                networkContainer.innerHTML = activityData.network_activity.map(network => `
                    <div class="activity-item" style="padding: 8px; margin: 4px 0; border-left: 3px solid #28a745; background: #f8f9fa;">
                        <div style="font-weight: 500; color: #28a745;">üåê ${network.event_type.replace(/_/g, ' ').toUpperCase()}</div>
                        <div style="font-size: 0.9em; color: #666;">
                            ${new Date(network.timestamp).toLocaleTimeString()} | 
                            ${network.connections_count ? `${network.connections_count} connections` : network.details} |
                            Impact: ${network.trust_impact > 0 ? '+' : ''}${network.trust_impact.toFixed(1)}
                        </div>
                    </div>
                `).join('');
            } else {
                networkContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem;">No recent network activity detected</p>';
            }
            
            // Update activity stats
            const stats = activityData.activity_stats;
            if (stats) {
                document.getElementById('total-events').textContent = stats.total_events || 0;
                document.getElementById('unique-apps').textContent = stats.unique_apps || 0;
                document.getElementById('network-connections').textContent = stats.network_connections || 0;
                document.getElementById('suspicious-events').textContent = stats.suspicious_events || 0;
            }
        }
        
        function updateTrustChart(history) {
            if (!history || history.length === 0) {
                document.getElementById('trust-chart').innerHTML = '<p style="text-align: center; color: #666; padding: 4rem;">üìà Collecting trust score data...</p>';
                return;
            }
            
            const timestamps = history.map(h => new Date(h.timestamp));
            const scores = history.map(h => parseFloat(h.score || 0));
            
            const trace = {
                x: timestamps,
                y: scores,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Trust Score',
                line: {
                    color: '#667eea',
                    width: 3
                },
                marker: {
                    color: '#764ba2',
                    size: 6
                },
                hovertemplate: '<b>Trust Score</b><br>Time: %{x}<br>Score: %{y:.1f}<extra></extra>'
            };
            
            const layout = {
                title: '',
                xaxis: {
                    title: 'Time',
                    type: 'date',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                yaxis: {
                    title: 'Trust Score',
                    range: [0, 100],
                    tickformat: '.1f',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                margin: { t: 30, r: 30, b: 60, l: 60 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Segoe UI, sans-serif' }
            };
            
            Plotly.newPlot('trust-chart', [trace], layout, {responsive: true});
        }
        
        function updateAnomaliesChart(anomalies) {
            if (!anomalies || anomalies.length === 0) {
                document.getElementById('anomalies-chart').innerHTML = '<p style="text-align: center; color: #666; padding: 4rem;">üìä No anomalies to display - system is stable!</p>';
                return;
            }
            
            // Group anomalies by hour for better visualization
            const anomaliesByHour = {};
            anomalies.forEach(anomaly => {
                const hour = new Date(anomaly.timestamp).toISOString().slice(0, 13) + ':00:00.000Z';
                if (!anomaliesByHour[hour]) {
                    anomaliesByHour[hour] = [];
                }
                anomaliesByHour[hour].push(anomaly);
            });
            
            const timestamps = Object.keys(anomaliesByHour).map(h => new Date(h));
            const counts = Object.values(anomaliesByHour).map(arr => arr.length);
            
            const trace = {
                x: timestamps,
                y: counts,
                type: 'bar',
                name: 'Anomalies per Hour',
                marker: {
                    color: counts.map(count => count > 10 ? '#dc3545' : count > 5 ? '#ffc107' : '#28a745'),
                    opacity: 0.8
                },
                hovertemplate: '<b>Anomalies</b><br>Hour: %{x}<br>Count: %{y}<extra></extra>'
            };
            
            const layout = {
                title: '',
                xaxis: {
                    title: 'Time',
                    type: 'date',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                yaxis: {
                    title: 'Anomaly Count',
                    tickformat: '.0f',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                margin: { t: 30, r: 30, b: 60, l: 60 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Segoe UI, sans-serif' }
            };
            
            Plotly.newPlot('anomalies-chart', [trace], layout, {responsive: true});
        }
        
        function formatAnomalyType(type) {
            const typeMap = {
                'unusual_time': 'üïê Unusual Time Activity',
                'unknown_application': '‚ùì Unknown Application',
                'rapid_switching': '‚ö° Rapid App Switching',
                'weekend_work': 'üìÖ Weekend Activity',
                'suspicious_pattern': 'üö® Suspicious Pattern',
                'connection_flooding': 'üåä Network Flooding',
                'network_connection': 'ÔøΩ Network Activity',
                'network_anomaly': 'üåê Network Anomaly',
                'security_tool': 'üîí Security Tool Detected',
                'app_launch': 'üöÄ App Launch',
                'general_anomaly': '‚ö†Ô∏è General Anomaly'
            };
            
            return typeMap[type] || `‚ö†Ô∏è ${type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
        }
        
        function showError(message) {
            console.error(message);
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 1000;
                font-size: 14px;
                max-width: 300px;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }
        
        // Handle page visibility changes for better performance
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                refreshDashboard();
                startAutoRefresh();
            }
        });
        
        // Manual refresh button with feedback
        window.refreshDashboard = refreshDashboard;
        
        // Add loading animation to refresh button
        const originalRefresh = refreshDashboard;
        window.refreshDashboard = function() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) {
                btn.textContent = 'üîÑ Refreshing...';
                btn.disabled = true;
            }
            
            originalRefresh().finally(() => {
                if (btn) {
                    btn.textContent = 'üîÑ Refresh Data';
                    btn.disabled = false;
                }
            });
        };
    </script>
</body>
</html>
